{% macro http_app(app) %}
    "{{ app.name }}": {
        "class": "Application",
        "template": "http",
        "serviceMain": {
            "class": "Service_HTTP",
            "virtualAddresses": [
                "{{ app.vs_ip }}"
            ],
            "pool": "{{ app.name }}_pool"
        },
        "{{ app.name }}_pool": {
            "class": "Pool",
            "monitors": [
                "http"
            ],
            "members": [{
                "servicePort": 80,
                "serverAddresses": [
                    {% for mem in app.members %}
                        "{{ mem }}"
                        {% if not loop.last %}
                            ,
                        {% endif %}
                    {% endfor %}
                ]
            }]
        }
    }
{% endmacro %}
{% macro https_app(app) %}
    "{{ app.name }}": {
        "class": "Application",
        "template": "https",
        "serviceMain": {
            "class": "Service_HTTPS",
            "serverTLS": "TLS_Offload",
            "virtualAddresses": [
                "{{ app.vs_ip }}"
            ],
            "pool": "{{ app.name }}_pool"
        },
        "{{ app.name }}_pool": {
            "class": "Pool",
            "monitors": [
                "http"
            ],
            "members": [{
                "servicePort": 443,
                "serverAddresses": [
                    {% for mem in app.members %}
                        "{{ mem }}"
                        {% if not loop.last %}
                            ,
                        {% endif %}
                    {% endfor %}
                ]
            }]
        },
        "TLS_Offload": {
            "class": "TLS_Server",
            "certificates": [
                {
                    "certificate": "{{ app.name }}_key_pair"
                }
            ]
        },
        "TLS_KeyPair": {
            "class": "Certificate",
            "certificate": "{{ app.certificate }}",
            "chainCA": "{{ app.chain_ca }}",
            "privateKey": "{{ app.private_key }}"
        }
    }
{% endmacro %}
{% macro render_app(app) %}
    {% if app.template == "http" %}
        {{ http_app(app) }}
    {% elif app.template == "https" %}
        {{ https_app(app) }}
    {% endif %}
{% endmacro %}
{
    "class": "AS3",
    "action": "deploy",
    "persist": true,
    "declaration": {
        "class": "ADC",
        "schemaVersion": "3.1.0",
        "id": "CR000008",
        "label": "test-label",
        "remark": "test-remark",
        "{{ tenant }}": {
            "class": "Tenant",
            {% for app in applications %}
                {{ render_app(app) }}
                    {% if not loop.last %}
                        ,
                    {% endif %}
            {% endfor %}
        }
    }
}